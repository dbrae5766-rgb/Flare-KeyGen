<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Flare - License Key Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
/* ================== THEME ================== */
:root {
    --primary-orange:#ff6b35;
    --dark-bg:#1a1a1a;
    --darker-bg:#0f0f0f;
    --card-bg:#252525;
    --text-primary:#e0e0e0;
    --text-secondary:#888;
    --border-color:#333;
    --hover-bg:#2a2a2a;
    --success-green:#4ade80;
    --error-red:#f87171;
}

*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:Inter,sans-serif;
    background:var(--darker-bg);
    color:var(--text-primary);
}

.key-code{
    font-family:"Courier New",monospace;
    color:var(--primary-orange);
    cursor:pointer;
}
.key-code:hover{
    text-decoration:underline;
}
input.key-edit{
    background:#111;
    border:1px solid var(--border-color);
    color:var(--primary-orange);
    font-family:"Courier New",monospace;
    font-size:13px;
    letter-spacing:1px;
    padding:2px 4px;
}
</style>
</head>

<body>

<div class="container">
    <h2>Active Keys</h2>
    <div id="keysList"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAH5OnErkAOdDKYMvBTtl4F6jV_1C8Ut4Y",
    authDomain: "flare-key-gen.firebaseapp.com",
    databaseURL: "https://flare-key-gen-default-rtdb.firebaseio.com",
    projectId: "flare-key-gen",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.db = db;
window.dbRef = ref;
window.dbSet = set;
window.dbPush = push;
window.dbOnValue = onValue;
window.dbGet = get;
window.dbRemove = remove;

loadKeys();
</script>

<script>
/* ================== ADMIN ================== */
const SPECIAL_IPS = ['69.170.112.226','175.37.240.44'];
let userIP = null;

async function checkUserIP(){
    const r = await fetch('https://api.ipify.org?format=json');
    const d = await r.json();
    userIP = d.ip;
}
checkUserIP();

function isAdminIP(){
    return SPECIAL_IPS.includes(userIP);
}

/* ================== LOAD KEYS ================== */
function loadKeys(){
    const keysRef = window.dbRef(window.db,'keys');
    window.dbOnValue(keysRef,(snap)=>{
        const list=document.getElementById('keysList');
        list.innerHTML='';
        const table=document.createElement('table');
        table.innerHTML=`
        <tr>
            <th>Key</th>
            <th>Status</th>
            <th>Expires</th>
        </tr>`;
        snap.forEach(c=>{
            const k=c.val();
            const tr=document.createElement('tr');
            tr.innerHTML=`
            <td>
                <span class="key-code"
                    ondblclick="enableKeyEdit(this,'${c.key}','${k.key}')"
                    title="Double click to edit"
                >${k.key}</span>
            </td>
            <td>${k.status}</td>
            <td>${new Date(k.expiresAt).toLocaleString()}</td>
            `;
            table.appendChild(tr);
        });
        list.appendChild(table);
    });
}

/* ================== EDIT KEY ================== */
function enableKeyEdit(span,keyId,oldKey){
    if(!isAdminIP()) return;

    const input=document.createElement('input');
    input.value=oldKey;
    input.className='key-edit';
    input.maxLength=19;

    span.replaceWith(input);
    input.focus();

    function save(){
        const newKey=input.value.trim().toUpperCase();
        if(newKey===oldKey){input.replaceWith(span);return;}

        updateKeyValue(keyId,newKey,span,input);
    }

    input.addEventListener('keydown',e=>{
        if(e.key==='Enter') save();
        if(e.key==='Escape') input.replaceWith(span);
    });
    input.addEventListener('blur',save);
}

async function updateKeyValue(keyId,newKey,span,input){
    if(!/^[A-Z0-9-]{19}$/.test(newKey)){
        alert('Invalid key format');
        input.focus();
        return;
    }

    const snap=await window.dbGet(window.dbRef(window.db,'keys'));
    let duplicate=false;
    snap.forEach(c=>{
        if(c.val().key===newKey && c.key!==keyId) duplicate=true;
    });
    if(duplicate){
        alert('Duplicate key');
        input.focus();
        return;
    }

    await window.dbSet(
        window.dbRef(window.db,`keys/${keyId}/key`),
        newKey
    );

    span.textContent=newKey;
    input.replaceWith(span);
}
</script>

</body>
</html>
